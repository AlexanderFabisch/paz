import pytest
import numpy as np
from paz.backend.image import load_image
from pipelines import MANOHandPoseEstimation


@pytest.fixture
def hand1():
    image = load_image('images/hand1.jpg')
    return image


@pytest.fixture
def labeled_global_pos_joints_hand1():
    return np.array([[-2.1095730e-01,  2.3746040e-01,  7.2351831e-01],
                     [-1.7486389e-01, -1.8858640e-02, -1.5466252e-01],
                     [-9.0742052e-02, -4.0452784e-01, -4.2383325e-01],
                     [-1.2175053e-01, -5.8097839e-01, -5.8229560e-01],
                     [-4.3585762e-09,  9.7836210e-09, -5.6013496e-09],
                     [2.8395301e-01, -4.0608984e-01, -2.2989722e-01],
                     [4.8385200e-01, -5.1372266e-01, -4.3877763e-01],
                     [-2.6156064e-02, -5.7355270e-02,  3.1983301e-01],
                     [6.7700726e-01,  1.6054958e-01, -3.8239870e-02],
                     [8.3818066e-01,  1.3827196e-01, -2.7829593e-01],
                     [4.1573428e-02, -4.7410838e-03,  1.4039090e-01],
                     [3.4360024e-01, -3.8029122e-01, -1.1138804e-01],
                     [6.3677025e-01, -3.9860457e-01, -2.7207798e-01],
                     [-1.6462585e-01,  3.9620602e-01,  6.2095523e-02],
                     [2.8221944e-01,  2.4856496e-01, -6.6663690e-02],
                     [8.2427993e-02,  2.2169314e-01, -3.2478195e-01],
                     [-1.8447973e-01, -8.4150827e-01, -7.5902623e-01],
                     [7.1065754e-01, -6.1353797e-01, -5.6427538e-01],
                     [9.9565113e-01,  7.2777450e-02, -2.9398090e-01],
                     [7.4763477e-01, -5.9318924e-01, -3.9086705e-01],
                     [-3.0818272e-01,  7.9595578e-01, -6.1133540e-01]])


@pytest.fixture
def uv_hand1():
    return np.array([[489, 894],
                     [550, 1022],
                     [795, 958],
                     [733, 894],
                     [672, 1278],
                     [489, 766],
                     [489, 511],
                     [489, 319],
                     [489, 191],
                     [550, 702],
                     [672, 511],
                     [795, 383],
                     [917, 383],
                     [550, 702],
                     [672, 511],
                     [917, 511],
                     [917, 383],
                     [489, 639],
                     [978, 958],
                     [1039, 894],
                     [1161, 894]])



def test_MANOHandPoseEstimationHand1(
        hand1, labeled_global_pos_joints_hand1, uv_hand1):
    detect = MANOHandPoseEstimation()
    inferences = detect(hand1)

    assert np.allclose(inferences['keypoints3D'],
                       labeled_global_pos_joints_hand1)
    assert np.allclose(inferences['keypoints2D'], uv_hand1)


@pytest.fixture
def hand2():
    image = load_image('images/hand2.jpg')
    return image


@pytest.fixture
def labeled_global_pos_joints_hand2():
    return np.array([[1.88204318e-01, 9.44696367e-01, -2.85254031e-01],
                     [-1.68596566e-01, -3.27465832e-02, -3.04927565e-02],
                     [-2.42465436e-01, -3.26091886e-01, 7.05712736e-02],
                     [-3.31479609e-01, -2.56886125e-01, 1.35164917e-01],
                     [1.50139723e-09, -5.24702912e-08, 4.69054022e-08],
                     [-8.45689327e-02, -4.25698161e-01, 1.69801623e-01],
                     [3.34348083e-02, -1.58395037e-01, 3.19741607e-01],
                     [1.26788139e-01, 1.49171457e-01, -2.84757078e-01],
                     [1.47574633e-01, -2.91041166e-01, -2.62394130e-01],
                     [1.76235601e-01, -3.48354697e-01, -2.34699249e-01],
                     [8.34700372e-03, 1.77722014e-02, -1.23329580e-01],
                     [7.72100240e-02, -2.85815865e-01, 1.09545663e-01],
                     [5.86296394e-02, -1.07758425e-01, 1.48863643e-01],
                     [-2.22503901e-01, 6.93074882e-01, -1.66780204e-01],
                     [-5.12608647e-01, 4.48076338e-01, -3.23797494e-01],
                     [-6.83783770e-01, 1.60146341e-01, -1.59252822e-01],
                     [-1.72300071e-01, -9.23789740e-01, -5.08257858e-02],
                     [-5.12108281e-02, -9.74470556e-01, 6.97554424e-02],
                     [4.66863871e-01, -5.40571451e-01, -1.17076010e-01],
                     [-1.40209913e-01, 1.84701145e-01, 5.77604286e-02],
                     [-8.99124742e-01, 3.55229266e-02, -2.03630298e-01]])


@pytest.fixture
def uv_hand2():
    return np.array([[300, 412],
                     [225, 412],
                     [187, 356],
                     [150, 300],
                     [112, 281],
                     [243, 262],
                     [225, 206],
                     [225, 243],
                     [281, 0],
                     [281, 262],
                     [281, 168],
                     [337, 262],
                     [281, 0],
                     [337, 262],
                     [356, 206],
                     [337, 262],
                     [281, 300],
                     [375, 300],
                     [431, 225],
                     [431, 187],
                     [431, 112]])



def test_MANOHandPoseEstimationHand2(
        hand2, labeled_global_pos_joints_hand2, uv_hand2):
    detect = MANOHandPoseEstimation()
    inferences = detect(hand2)

    assert np.allclose(inferences['keypoints3D'],
                       labeled_global_pos_joints_hand2)
    assert np.allclose(inferences['keypoints2D'], uv_hand2)


@pytest.fixture
def hand3():
    image = load_image('images/hand3.jpg')
    return image


@pytest.fixture
def labeled_global_pos_joints_hand3():
    return np.array([[8.1149392e-02, 9.7421163e-01, 1.4497130e-01],
                     [-2.4719435e-01, 2.7672350e-02, 4.0200585e-03],
                     [-3.9584926e-01, -3.8725662e-01, 2.4722364e-02],
                     [-5.2944553e-01, -6.5712583e-01, -9.3531311e-03],
                     [-5.1799698e-10, -4.2153703e-10, 1.5513901e-09],
                     [-5.6642253e-02, -4.1693839e-01, 3.8588528e-02],
                     [-3.8486376e-02, -7.2283918e-01, -9.7781003e-02],
                     [4.3955427e-01, 1.8262622e-01, -1.4219971e-01],
                     [6.2215132e-01, -1.4008403e-01, -1.0473878e-01],
                     [7.1468371e-01, -2.8577697e-01, -6.9761820e-02],
                     [1.9138500e-01, 4.7994040e-02, -7.5710773e-02],
                     [3.0327004e-01, -3.1055903e-01, -1.3556108e-03],
                     [4.3489704e-01, -5.7546860e-01, -5.6770772e-02],
                     [-2.6034012e-01, 7.2023141e-01, 5.6327134e-03],
                     [-5.0139296e-01, 4.7852150e-01, -1.5718439e-01],
                     [-6.9825906e-01, 2.3603703e-01, -2.8884244e-01],
                     [-5.5761278e-01, -9.2161906e-01, -6.2653527e-02],
                     [-2.7442642e-02, -1.0280274e+00, -4.9207374e-02],
                     [8.4589291e-01, -4.8254442e-01, -7.4146524e-02],
                     [5.2343649e-01, -9.2888176e-01, -7.5384378e-02],
                     [-8.9133555e-01, 4.9607728e-02, -3.4057701e-01]])


@pytest.fixture
def uv_hand3():
    return np.array([[190, 255],
                     [158, 234],
                     [116, 213],
                     [95, 170],
                     [63, 149],
                     [148, 149],
                     [137, 106],
                     [127, 74],
                     [116, 42],
                     [180, 149],
                     [180, 95],
                     [180, 53],
                     [180, 21],
                     [201, 149],
                     [222, 106],
                     [222, 74],
                     [233, 42],
                     [233, 159],
                     [243, 127],
                     [264, 106],
                     [275, 85]])



def test_MANOHandPoseEstimationHand3(
        hand3, labeled_global_pos_joints_hand3, uv_hand3):
    detect = MANOHandPoseEstimation()
    inferences = detect(hand3)

    assert np.allclose(inferences['keypoints3D'],
                       labeled_global_pos_joints_hand3)
    assert np.allclose(inferences['keypoints2D'], uv_hand3)
